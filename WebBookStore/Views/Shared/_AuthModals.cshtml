@* Login Modal *@
<div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-semibold" id="loginModalLabel">Đăng nhập</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("Login", "Account", FormMethod.Post, new { id = "loginForm", @class = "needs-validation", novalidate = "novalidate" }))
                {
                    @Html.AntiForgeryToken()
                    <div class="mb-3">
                        <label for="Email" class="form-label">Email</label>
                        <input type="text" class="form-control" id="Email" name="Email" required>
                    </div>
                    <div class="mb-3">
                        <label for="Password" class="form-label">Mật khẩu</label>
                        <input type="password" class="form-control" id="Password" name="Password" required>
                    </div>
                    <div class="mb-3 form-check d-flex justify-content-between">
                        <div>
                            <input type="checkbox" class="form-check-input" id="RememberMe" name="RememberMe">
                            <label class="form-check-label" for="RememberMe">Ghi nhớ</label>
                        </div>
                        <a href="#" class="text-primary text-decoration-none">Quên mật khẩu?</a>
                    </div>
                    <div id="loginErrors"></div>
                    <button type="submit" class="btn btn-primary w-100">Đăng nhập</button>
                }
            </div>
            <div class="modal-footer text-center">
                <div class="w-100">
                    <div class="position-relative">
                        <hr>
                        <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted">Hoặc</span>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button type="button" class="btn btn-outline-danger" onclick="showComingSoon('Google')">
                            <i class="fab fa-google me-2"></i>Đăng nhập với Google
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="showComingSoon('Facebook')">
                            <i class="fab fa-facebook-f me-2"></i>Đăng nhập với Facebook
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted">Chưa có tài khoản?</span>
                        <a href="#" class="text-primary text-decoration-none" data-bs-toggle="modal" data-bs-target="#registerModal" data-bs-dismiss="modal">Đăng ký ngay</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@* Register Modal *@
<div class="modal fade" id="registerModal" tabindex="-1" aria-labelledby="registerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content shadow-lg">
            <div class="modal-header">
                <h5 class="modal-title fw-semibold" id="registerModalLabel">Đăng ký</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                @using (Html.BeginForm("Register", "Account", FormMethod.Post, new { id = "registerForm", @class = "needs-validation", novalidate = "novalidate" }))
                {
                    @Html.AntiForgeryToken()
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="FullName" class="form-label">Họ tên *</label>
                                <input type="text" class="form-control" id="FullName" name="FullName" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="Email" class="form-label">Email *</label>
                                <input type="email" class="form-control" id="Email" name="Email" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="Password" class="form-label">Mật khẩu *</label>
                                <input type="password" class="form-control" id="Password" name="Password" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="ConfirmPassword" class="form-label">Xác nhận mật khẩu *</label>
                                <input type="password" class="form-control" id="ConfirmPassword" name="ConfirmPassword" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="PhoneNumber" class="form-label">Số điện thoại</label>
                                <input type="tel" class="form-control" id="PhoneNumber" name="PhoneNumber">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="Address" class="form-label">Địa chỉ</label>
                                <input type="text" class="form-control" id="Address" name="Address">
                            </div>
                        </div>
                    </div>
                    <div id="registerErrors"></div>
                    <button type="submit" class="btn btn-primary w-100">Đăng ký</button>
                }
            </div>
            <div class="modal-footer text-center">
                <div class="w-100">
                    <div class="position-relative">
                        <hr>
                        <span class="position-absolute top-50 start-50 translate-middle bg-white px-3 text-muted">Hoặc</span>
                    </div>
                    <div class="d-grid gap-2 mt-3">
                        <button type="button" class="btn btn-outline-danger" onclick="showComingSoon('Google')">
                            <i class="fab fa-google me-2"></i>Đăng ký với Google
                        </button>
                        <button type="button" class="btn btn-outline-primary" onclick="showComingSoon('Facebook')">
                            <i class="fab fa-facebook-f me-2"></i>Đăng ký với Facebook
                        </button>
                    </div>
                    <div class="mt-3">
                        <span class="text-muted">Đã có tài khoản?</span>
                        <a href="#" class="text-primary text-decoration-none" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">Đăng nhập ngay</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Login form submission
        $('#loginForm').on('submit', function(e) {
            e.preventDefault();
            console.log('[DEBUG] Login form submit triggered');
            
            var form = $(this);
            var submitBtn = form.find('button[type="submit"]');
            var originalText = submitBtn.html();
            
            // Show loading state
            submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');
            submitBtn.prop('disabled', true);
            
            // Clear previous errors
            $('#loginErrors').empty();
            
            // Get form data
            var formData = form.serialize();
            console.log('[DEBUG] Form data:', formData);
            
            // Send AJAX request using jQuery
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    console.log('[DEBUG] Login response:', response);
                    
                    if (response.success || response.ok) {
                        console.log('[LOGIN SUCCESS] Response:', response);
                        
                        // Show success message
                        $('#loginErrors').html('<div class="alert alert-success small mb-0">' + (response.message || 'Đăng nhập thành công!') + '</div>');
                        
                        // Redirect after short delay
                        setTimeout(function() {
                            if (response.redirectUrl) {
                                console.log('[LOGIN SUCCESS] Redirecting to:', response.redirectUrl);
                                window.location.replace(response.redirectUrl);
                            } else {
                                console.log('[LOGIN SUCCESS] Reloading page');
                                window.location.reload();
                            }
                        }, 500);
                    } else {
                        // Show error message
                        var errorMsg = response.message || 'Email hoặc mật khẩu không đúng';
                        $('#loginErrors').html('<div class="alert alert-danger small mb-0">' + errorMsg + '</div>');
                        
                        // Reset button
                        submitBtn.html(originalText);
                        submitBtn.prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('[DEBUG] Login AJAX error:', error);
                    console.error('[DEBUG] Response text:', xhr.responseText);
                    
                    var errorMsg = 'Có lỗi xảy ra khi đăng nhập';
                    try {
                        var response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMsg = response.message;
                        }
                    } catch (e) {
                        // Use default error message
                    }
                    
                    $('#loginErrors').html('<div class="alert alert-danger small mb-0">' + errorMsg + '</div>');
                    
                    // Reset button
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                }
            });
        });
        
        // Register form submission
        $('#registerForm').on('submit', function(e) {
            e.preventDefault();
            console.log('[DEBUG] Register form submit triggered');
            
            var form = $(this);
            var submitBtn = form.find('button[type="submit"]');
            var originalText = submitBtn.html();
            
            // Show loading state
            submitBtn.html('<span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý...');
            submitBtn.prop('disabled', true);
            
            // Clear previous errors
            $('#registerErrors').empty();
            
            // Get form data
            var formData = form.serialize();
            console.log('[DEBUG] Register form data:', formData);
            
            // Send AJAX request using jQuery
            $.ajax({
                url: form.attr('action'),
                type: 'POST',
                data: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                success: function(response) {
                    console.log('[DEBUG] Register response:', response);
                    
                    if (response.success || response.ok) {
                        console.log('[REGISTER SUCCESS] Response:', response);
                        
                        // Show success message
                        $('#registerErrors').html('<div class="alert alert-success small mb-0">' + (response.message || 'Đăng ký thành công!') + '</div>');
                        
                        // Reset button
                        submitBtn.html(originalText);
                        submitBtn.prop('disabled', false);
                    } else {
                        // Show error message
                        var errorMsg = response.message || 'Có lỗi xảy ra khi đăng ký';
                        $('#registerErrors').html('<div class="alert alert-danger small mb-0">' + errorMsg + '</div>');
                        
                        // Reset button
                        submitBtn.html(originalText);
                        submitBtn.prop('disabled', false);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('[DEBUG] Register AJAX error:', error);
                    
                    var errorMsg = 'Có lỗi xảy ra khi đăng ký';
                    try {
                        var response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMsg = response.message;
                        }
                    } catch (e) {
                        // Use default error message
                    }
                    
                    $('#registerErrors').html('<div class="alert alert-danger small mb-0">' + errorMsg + '</div>');
                    
                    // Reset button
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                }
            });
        });
        
        // Clear errors when modal is shown
        $('#loginModal').on('show.bs.modal', function() {
            $('#loginErrors').empty();
        });
        
        $('#registerModal').on('show.bs.modal', function() {
            $('#registerErrors').empty();
        });
        
        // Function to show coming soon message
        window.showComingSoon = function(provider) {
            alert('Đăng nhập với ' + provider + ' đang được phát triển. Vui lòng sử dụng đăng nhập thông thường.');
        };
    });
</script>